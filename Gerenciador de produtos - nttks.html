<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Produtos - Nttks_indica</title>
    <!-- Carrega o Tailwind CSS para estilização fácil -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte 'Inter' do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define o nível de log para ver mensagens de depuração no console.
        setLogLevel('debug');

        const productForm = document.getElementById('product-form');
        const userIdElement = document.getElementById('user-id');
        const productsListContainer = document.getElementById('products-list-container');
        
        let db, auth;
        
        // As variáveis globais __app_id, __firebase_config e __initial_auth_token são fornecidas pelo ambiente.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Tenta fazer login com o token fornecido, caso contrário, faz login anonimamente.
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    const userId = auth.currentUser.uid;
                    userIdElement.textContent = `Seu ID de usuário: ${userId}`;
                    setupRealtimeListener(userId);
                } catch (error) {
                    console.error("Erro de autenticação:", error);
                    alert('Erro ao autenticar. Por favor, tente novamente.');
                }
            }
            authenticate();
        } else {
            alert('Erro: A configuração do Firebase não foi encontrada. Este arquivo deve ser executado na plataforma Canvas.');
        }

        // Adiciona um novo produto ao Firestore
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(productForm);
            const productData = {
                name: formData.get('name'),
                price: formData.get('price'),
                description: formData.get('description'),
                imageUrl: formData.get('imageUrl'),
                link: formData.get('link'),
                productCode: formData.get('productCode'),
                segment: formData.get('segment'),
                marketplace: formData.get('marketplace')
            };

            // Valida os campos obrigatórios
            if (!productData.name || !productData.link) {
                alert("Por favor, preencha o Nome e o Link.");
                return;
            }

            try {
                const productsCollection = collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/products`);
                await addDoc(productsCollection, productData);
                console.log("Produto adicionado com sucesso!");
                productForm.reset();
            } catch (error) {
                console.error("Erro ao adicionar produto:", error);
                alert("Ocorreu um erro ao adicionar o produto. Verifique sua conexão.");
            }
        });

        // Configura o listener em tempo real para exibir a lista de produtos.
        function setupRealtimeListener(userId) {
            const productsCollection = collection(db, `artifacts/${appId}/users/${userId}/products`);
            onSnapshot(productsCollection, (querySnapshot) => {
                const products = [];
                querySnapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProductsList(products);
                console.log('Lista de produtos carregada com sucesso.');
            }, (error) => {
                console.error("Erro ao carregar a lista de produtos:", error);
            });
        }

        function renderProductsList(products) {
            productsListContainer.innerHTML = '';
            if (products.length === 0) {
                productsListContainer.innerHTML = '<p class="text-center text-gray-500">Nenhum produto cadastrado.</p>';
                return;
            }

            products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.classList.add('bg-gray-100', 'p-4', 'rounded-lg', 'shadow-sm', 'border-l-4', 'border-purple-500', 'flex', 'flex-col', 'space-y-1', 'text-sm');
                productItem.innerHTML = `
                    <p class="font-bold text-gray-800">${product.name}</p>
                    ${product.productCode ? `<p class="text-xs text-gray-600">Código: ${product.productCode}</p>` : ''}
                    ${product.price ? `<p class="text-xs text-green-600">Preço: ${product.price}</p>` : ''}
                `;
                productsListContainer.appendChild(productItem);
            });
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800 flex justify-center items-center min-h-screen p-4;
        }
        .container {
            @apply w-full max-w-xl bg-white p-6 rounded-3xl shadow-lg border-2 border-gray-200;
        }
        .product-form input, .product-form textarea, .product-form select {
            @apply p-3 border rounded-lg w-full text-sm;
        }
        .product-form label {
            @apply text-sm font-medium text-gray-700 block mb-1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                Gerenciar Catálogo
            </h1>
            <p class="mt-2 text-md text-gray-600">
                Adicione, edite e organize seus produtos.
            </p>
        </header>

        <!-- Informação do Usuário -->
        <p id="user-id" class="text-center text-sm text-gray-500 mb-4"></p>

        <!-- Formulário para adicionar produtos -->
        <section>
            <form id="product-form" class="product-form grid gap-4">
                <div>
                    <label for="name">Nome do Produto *</label>
                    <input type="text" id="name" name="name" placeholder="Pelúcia Stitch" required>
                </div>
                <div>
                    <label for="price">Preço</label>
                    <input type="text" id="price" name="price" placeholder="Ex: 250.00 (use ponto para centavos)">
                </div>
                <div>
                    <label for="productCode">Código do Produto</label>
                    <input type="text" id="productCode" name="productCode" placeholder="PC-001">
                </div>
                 <div>
                    <label for="segment">Segmento</label>
                    <input type="text" id="segment" name="segment" placeholder="Ex: Casa, Mesa e Banho">
                </div>
                <div>
                    <label for="marketplace">Marketplace</label>
                    <select id="marketplace" name="marketplace" class="w-full">
                        <option value="">Selecione um marketplace</option>
                        <option value="Amazon">Amazon</option>
                        <option value="Shopee">Shopee</option>
                        <option value="Aliexpress">Aliexpress</option>
                        <option value="Mercado Livre">Mercado Livre</option>
                    </select>
                </div>
                <div>
                    <label for="description">Descrição</label>
                    <textarea id="description" name="description" rows="3" placeholder="Pelúcia do Stitch, macia e fofa"></textarea>
                </div>
                <div>
                    <label for="imageUrl">URL da Imagem</label>
                    <input type="url" id="imageUrl" name="imageUrl" placeholder="https://exemplo.com/imagem.jpg">
                </div>
                <div>
                    <label for="link">Link de Afiliado *</label>
                    <input type="url" id="link" name="link" placeholder="https://shopee.com.br/link" required>
                </div>
                <button type="submit" class="mt-4 w-full px-6 py-3 text-center text-lg font-bold text-white bg-gradient-to-r from-purple-600 to-pink-600 rounded-full shadow-lg hover:from-purple-700 hover:to-pink-700 transition-all transform hover:scale-105">
                    Adicionar Produto
                </button>
            </form>
        </section>

        <!-- Lista de produtos cadastrados -->
        <section class="mt-8">
            <h2 class="text-xl font-bold mb-4 text-center">Produtos Cadastrados</h2>
            <div id="products-list-container" class="grid gap-4">
                <!-- A lista de produtos será injetada aqui pelo JavaScript -->
            </div>
        </section>
    </div>
</body>
</html>
